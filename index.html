<script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const VPA = 'BHARATPE.8K0T0X8C8U10501@fbpe';
    const PAYEE_NAME = 'sourav kumar';
    const WHATSAPP_NUMBER = '919060808433';

    const PaymentModal = ({ amount, note, baseParams, qrCodeUrl, vpa, onClose }) => {
        const [isCopied, setIsCopied] = useState(false);

        const handleCopyVpa = () => {
            navigator.clipboard.writeText(vpa).then(() => {
                setIsCopied(true);
                setTimeout(() => setIsCopied(false), 2000);
            });
        };

        // App-specific URIs (these have much higher success rates for BharatPe merchants)
        const genericUri = `upi://pay?${baseParams.toString()}`;
        const phonepeUri = `phonepe://pay?${baseParams.toString()}`;
        const paytmUri = `paytmmp://pay?${baseParams.toString()}`;
        const bhimUri = `bhim://pay?${baseParams.toString()}`;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center relative">
                    <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    
                    <h2 className="text-xl font-bold text-gray-800">Complete Your Payment</h2>
                    <p className="text-gray-600 mt-1">Paying <span className="font-bold text-2xl">₹{amount}</span></p>

                    <img src={qrCodeUrl} alt="UPI QR Code" className="w-60 h-60 mx-auto my-4 border-4 border-green-500 rounded-lg" />
                    
                    <p className="text-sm font-semibold text-gray-700">Best: Scan QR (works 100%)</p>
                    
                    <div className="text-xs text-left bg-gray-50 p-3 rounded-lg mt-3 space-y-1">
                       <p><strong>Easiest:</strong></p>
                       <p>1. Screenshot this screen.</p>
                       <p>2. Open UPI app → Scan from Gallery.</p>
                    </div>
                    
                    <div className="mt-5 space-y-3">
                        <p className="text-sm font-semibold text-gray-700">Or try direct app links (if installed):</p>
                        
                        <a href={phonepeUri} className="block w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">Open PhonePe →</a>
                        
                        <a href={paytmUri} className="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Open Paytm →</a>
                        
                        <a href={bhimUri} className="block w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition">Open BHIM →</a>
                        
                        <a href={genericUri} className="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition">Open Other UPI App →</a>
                    </div>

                    <div className="flex items-center justify-center gap-2 mt-4">
                        <p className="text-gray-600 text-sm">UPI ID: <strong className="font-mono">{vpa}</strong></p>
                        <button onClick={handleCopyVpa} className="p-1 rounded-md hover:bg-gray-200">
                            {isCopied ? <span className="text-green-500 text-sm font-semibold">Copied!</span> : <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>}
                        </button>
                    </div>

                    <p className="text-xs text-gray-500 mt-4">If link fails → use QR scan (most reliable).</p>
                </div>
            </div>
        );
    };

    const App = () => {
        // ... (keep all your existing state/effects)

        const tr = useMemo(() => `ORD${Date.now()}${Math.floor(Math.random() * 1000)}`, [amount, note]); // Unique ref

        const baseParams = useMemo(() => {
            const params = new URLSearchParams({ 
                pa: VPA, 
                pn: PAYEE_NAME, 
                cu: 'INR',
                tr: tr  // Add unique transaction ref
            });
            if (isAmountValid) params.set('am', parseFloat(amount).toFixed(2));
            params.set('tn', note.trim() || 'Payment');
            return params;
        }, [amount, note, isAmountValid, tr]);

        const upiUri = `upi://pay?${baseParams.toString()}`; // For backward compatibility
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiUri)}`;

        // ... (rest of your handlers unchanged)

        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                {showPaymentModal && <PaymentModal amount={parseFloat(amount).toFixed(2)} note={note} baseParams={baseParams} qrCodeUrl={qrCodeUrl} vpa={VPA} onClose={() => setShowPaymentModal(false)} />}
                {/* ... rest of your JSX unchanged */}
            </div>
        );
    };

    // ... root render unchanged
</script>
